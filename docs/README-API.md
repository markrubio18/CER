# ðŸ”Œ Complete API Reference Guide

**Comprehensive API documentation for all system endpoints**

ðŸ“– **Quick Reference**: See [README.md](../README.md) for system overview and authentication setup

## Base URL

- Local development: `http://localhost:3000`

## Authentication

Protected endpoints accept either:
- NextAuth session cookies (from the web UI), or
- Bearer tokens (recommended for programmatic API use)

### Obtain a token

POST `/api/auth/token`

Request body:
```json
{ "username": "admin", "password": "admin123" }
```

Response:
```json
{
  "access_token": "<JWT>",
  "token_type": "Bearer",
  "expires_in": 86400
}
```

Use the token in subsequent calls:
```
Authorization: Bearer <JWT>
```

Environment notes:
- Set a strong `NEXTAUTH_SECRET` (or `AUTH_SECRET`).
- `SESSION_MAX_AGE` controls token lifetime (seconds).

## Certificate Authority (CA)

### Get CA status list
GET `/api/ca/status`

```
curl -H "authorization: Bearer $TOKEN" \
  http://localhost:3000/api/ca/status
```

### Get CA details
GET `/api/ca/{id}`

```
curl -H "authorization: Bearer $TOKEN" \
  http://localhost:3000/api/ca/<CA_ID>
```

### Delete a CA (and all its artifacts)
DELETE `/api/ca/{id}`

```
curl -X DELETE -H "authorization: Bearer $TOKEN" \
  http://localhost:3000/api/ca/<CA_ID>
```

### Initialize CA (CSR-based)
POST `/api/ca/initialize`

Request body (example):
```json
{
  "name": "Org CA",
  "subjectDN": "C=US,ST=CA,L=SF,O=MyOrg,OU=IT,CN=Root CA",
  "keyAlgorithm": "RSA",
  "keySize": 4096
}
```
Response contains `{ caId, csr, privateKey }`.

### Upload signed CA certificate
POST `/api/ca/upload-certificate`

Request body:
```json
{
  "caId": "<CA_ID>",
  "certificate": "-----BEGIN CERTIFICATE-----...",
  "certificateChain": "-----BEGIN CERTIFICATE-----..."
}
```

Extended formats (opt-in via `ALLOW_EXTENDED_CERT_FORMATS=true`):
- `certificateBinary` (base64) with `certificateBinaryFormat`: `der` or `p7b`
- Optional `chainBinary` + `chainBinaryFormat`

### Create a self-signed CA (one-step)
POST `/api/ca/self-signed`

Request body (example):
```json
{
  "name": "Demo CA",
  "subjectDN": "C=US,ST=CA,L=SF,O=Demo,OU=IT,CN=Demo Root CA",
  "keyAlgorithm": "RSA",
  "keySize": 2048,
  "validityDays": 3650,
  "force": false
}
```

Response contains `{ id, certificate }` and activates the CA immediately.

## Certificates

### Issue a certificate
POST `/api/certificates/issue`

Request (key pair generated by CA):
```json
{
  "subjectDN": "CN=test.example.com",
  "certificateType": "SERVER",
  "keyAlgorithm": "RSA",
  "keySize": 2048,
  "validityDays": 365,
  "sans": ["test.example.com", "www.test.example.com"]
}
```

Request (external CSR):
```json
{
  "subjectDN": "CN=test.example.com",
  "certificateType": "SERVER",
  "keyAlgorithm": "RSA",
  "validityDays": 365,
  "csr": "-----BEGIN CERTIFICATE REQUEST-----..."
}
```

Response contains `{ certificate, privateKey?, serialNumber, fingerprint }`.

Notes:
- `certificateType`: `SERVER` | `CLIENT` | `CA`
- For `SERVER`, at least one SAN is required; max validity 398 days.
- `keyAlgorithm`: `RSA` or `ECDSA` (Ed25519 not supported for signing).

### List certificates
GET `/api/certificates?limit=20&page=1&type=SERVER&status=ACTIVE&subjectDN=example.com`

### Revoke a certificate
POST `/api/certificates/revoke`

```json
{ "serialNumber": "<HEX>", "reason": "KEY_COMPROMISE" }
```

Allowed reasons:
`UNSPECIFIED, KEY_COMPROMISE, CA_COMPROMISE, AFFILIATION_CHANGED, SUPERSEDED, CESSATION_OF_OPERATION, CERTIFICATE_HOLD, REMOVE_FROM_CRL, PRIVILEGE_WITHDRAWN, AA_COMPROMISE`

### Renew a certificate
POST `/api/certificates/{serialNumber}/renew`

## CRL (Certificate Revocation List)

### Generate CRL
POST `/api/crl/generate`

```json
{ "type": "full", "caId": "<optional>" }
```

For delta CRL:
```json
{ "type": "delta", "caId": "<optional>" }
```

Response includes the PEM CRL.

### Download latest CRL
GET `/api/crl/download/latest`

### Download CRL by number
GET `/api/crl/download/{crlNumber}`

### CRL status and export
- GET `/api/crl/status`
- GET `/api/crl/export`

### Validate a CRL (structure/compliance)
POST `/api/crl/validate`

```json
{ "crlPem": "-----BEGIN X509 CRL-----..." }
```

## OCSP

### JSON OCSP
POST `/api/ocsp`

Body: implementation-specific certificate status query.

### Binary OCSP (RFC 6960)
POST `/api/ocsp/binary`

Headers:
```
content-type: application/ocsp-request
accept: application/ocsp-response
```

Body: DER-encoded OCSP request bytes.

## Admin Settings APIs

### Authentication & Permissions

All admin endpoints require:
- **Authentication**: Valid session or Bearer token
- **Permission**: `config:manage` permission required
- **Role**: Administrator role required

### Security Settings API

#### Get Security Configuration
**GET** `/api/admin/security`

**Response:**
```json
{
  "passwordPolicy": {
    "minLength": 8,
    "requireUppercase": true,
    "requireLowercase": true,
    "requireNumbers": true,
    "requireSpecialChars": true,
    "preventReuse": 5,
    "expiryDays": 90
  },
  "sessionConfig": {
    "timeoutMinutes": 30,
    "maxConcurrentSessions": 5,
    "extendOnActivity": true,
    "rememberMeDays": 30
  },
  "auditConfig": {
    "enabled": true,
    "logLevel": "info",
    "retentionDays": 365,
    "alertOnSuspicious": true
  }
}
```

#### Update Password Policy
**POST** `/api/admin/security`

**Request:**
```json
{
  "action": "updatePasswordPolicy",
  "config": {
    "passwordPolicy": {
      "minLength": 12,
      "requireUppercase": true,
      "requireLowercase": true,
      "requireNumbers": true,
      "requireSpecialChars": true,
      "preventReuse": 5,
      "expiryDays": 90
    }
  }
}
```

#### Update Session Configuration
**POST** `/api/admin/security`

**Request:**
```json
{
  "action": "updateSessionConfig",
  "config": {
    "sessionConfig": {
      "timeoutMinutes": 60,
      "maxConcurrentSessions": 3,
      "extendOnActivity": true,
      "rememberMeDays": 7
    }
  }
}
```

#### Update Audit Configuration
**POST** `/api/admin/security`

**Request:**
```json
{
  "action": "updateAuditConfig",
  "config": {
    "auditConfig": {
      "enabled": true,
      "logLevel": "debug",
      "retentionDays": 180,
      "alertOnSuspicious": true
    }
  }
}
```

### Certificate Authority Settings API

#### Get CA Configuration
**GET** `/api/admin/ca`

**Response:**
```json
{
  "renewalPolicy": {
    "autoRenewalEnabled": false,
    "renewalThresholdDays": 30,
    "maxRenewalAttempts": 3,
    "renewalNotificationDays": 7
  },
  "certificateTemplates": {
    "defaultValidityDays": 365,
    "defaultKeySize": 2048,
    "defaultAlgorithm": "RSA",
    "allowCustomExtensions": true
  },
  "crlSettings": {
    "enabled": true,
    "updateIntervalHours": 24,
    "includeRevokedCerts": true,
    "crlDistributionPoints": ["https://yourdomain.com/crl/latest.crl"]
  },
  "ocspSettings": {
    "enabled": true,
    "responderUrl": "https://yourdomain.com/ocsp",
    "cacheTimeoutMinutes": 60,
    "includeNextUpdate": true
  }
}
```

#### Update CA Renewal Policy
**POST** `/api/admin/ca`

**Request:**
```json
{
  "action": "updateRenewalPolicy",
  "config": {
    "renewalPolicy": {
      "autoRenewalEnabled": true,
      "renewalThresholdDays": 45,
      "maxRenewalAttempts": 5,
      "renewalNotificationDays": 14
    }
  }
}
```

#### Update Certificate Templates
**POST** `/api/admin/ca`

**Request:**
```json
{
  "action": "updateCertificateTemplates",
  "config": {
    "certificateTemplates": {
      "defaultValidityDays": 730,
      "defaultKeySize": 4096,
      "defaultAlgorithm": "ECDSA",
      "allowCustomExtensions": false
    }
  }
}
```

#### Update CRL Settings
**POST** `/api/admin/ca`

**Request:**
```json
{
  "action": "updateCrlSettings",
  "config": {
    "crlSettings": {
      "enabled": true,
      "updateIntervalHours": 12,
      "includeRevokedCerts": true,
      "crlDistributionPoints": [
        "https://primary.crl.example.com/latest.crl",
        "https://backup.crl.example.com/latest.crl"
      ]
    }
  }
}
```

#### Update OCSP Settings
**POST** `/api/admin/ca`

**Request:**
```json
{
  "action": "updateOcspSettings",
  "config": {
    "ocspSettings": {
      "enabled": true,
      "responderUrl": "https://ocsp.example.com",
      "cacheTimeoutMinutes": 30,
      "includeNextUpdate": true
    }
  }
}
```

### Performance & Monitoring API

#### Get Performance Configuration
**GET** `/api/admin/performance`

**Response:**
```json
{
  "healthChecks": {
    "enabled": true,
    "checkIntervalMinutes": 5,
    "timeoutSeconds": 30,
    "failureThreshold": 3
  },
  "performanceMetrics": {
    "enabled": true,
    "collectionIntervalMinutes": 1,
    "dataRetentionDays": 30,
    "cpuThreshold": 80,
    "memoryThreshold": 85,
    "diskThreshold": 90,
    "responseTimeThreshold": 5000
  },
  "resourceLimits": {
    "maxCpuUsage": 90,
    "maxMemoryUsage": 90,
    "maxDiskUsage": 95,
    "maxConcurrentConnections": 1000,
    "rateLimitRequestsPerMinute": 1000
  }
}
```

#### Update Health Checks
**POST** `/api/admin/performance`

**Request:**
```json
{
  "action": "updateHealthChecks",
  "config": {
    "healthChecks": {
      "enabled": true,
      "checkIntervalMinutes": 10,
      "timeoutSeconds": 60,
      "failureThreshold": 5
    }
  }
}
```

#### Update Performance Metrics
**POST** `/api/admin/performance`

**Request:**
```json
{
  "action": "updateMetrics",
  "config": {
    "performanceMetrics": {
      "enabled": true,
      "collectionIntervalMinutes": 5,
      "dataRetentionDays": 90,
      "cpuThreshold": 75,
      "memoryThreshold": 80,
      "diskThreshold": 85,
      "responseTimeThreshold": 3000
    }
  }
}
```

#### Update Resource Limits
**POST** `/api/admin/performance`

**Request:**
```json
{
  "action": "updateResourceLimits",
  "config": {
    "resourceLimits": {
      "maxCpuUsage": 85,
      "maxMemoryUsage": 85,
      "maxDiskUsage": 90,
      "maxConcurrentConnections": 500,
      "rateLimitRequestsPerMinute": 500
    }
  }
}
```

### System Configuration API

#### Get System Configuration
**GET** `/api/admin/system-config`

**Response:**
```json
{
  "databaseType": "SQLite",
  "databaseUrl": "configured",
  "maintenanceMode": false,
  "maintenanceMessage": "System is currently under maintenance. Please try again later.",
  "environmentVariables": {
    "NODE_ENV": "production",
    "DATABASE_URL": "file:./db/custom.db",
    "NEXTAUTH_SECRET": "configured"
  }
}
```

#### Toggle Maintenance Mode
**POST** `/api/admin/system-config`

**Request:**
```json
{
  "action": "toggleMaintenance",
  "config": {
    "maintenanceMode": true,
    "maintenanceMessage": "Scheduled maintenance in progress. Please try again in 30 minutes."
  }
}
```

#### Create Database Backup
**POST** `/api/admin/system-config`

**Request:**
```json
{
  "action": "createBackup",
  "config": {}
}
```

#### List Database Backups
**POST** `/api/admin/system-config`

**Request:**
```json
{
  "action": "listBackups",
  "config": {}
}
```

#### Delete Database Backup
**POST** `/api/admin/system-config`

**Request:**
```json
{
  "action": "deleteBackup",
  "config": {
    "filename": "backup_2025-01-15_14-30-00.db"
  }
}
```

### Notifications & Integrations API

#### Get Notifications Configuration
**GET** `/api/admin/notifications`

**Response:**
```json
{
  "smtpConfig": {
    "host": "smtp.example.com",
    "port": 587,
    "secure": false,
    "auth": {
      "user": "noreply@example.com",
      "pass": "configured"
    }
  },
  "alertThresholds": {
    "certificateExpiryDays": 30,
    "crlUpdateHours": 25,
    "diskUsagePercent": 85,
    "memoryUsagePercent": 90
  },
  "webhookSettings": {
    "enabled": true,
    "url": "https://api.example.com/webhooks/ca-events",
    "secret": "configured",
    "events": ["certificate_issued", "certificate_revoked", "crl_updated"]
  }
}
```

#### Update SMTP Configuration
**POST** `/api/admin/notifications`

**Request:**
```json
{
  "action": "updateSmtpConfig",
  "config": {
    "smtpConfig": {
      "host": "smtp.gmail.com",
      "port": 587,
      "secure": false,
      "auth": {
        "user": "noreply@example.com",
        "pass": "your-app-password"
      }
    }
  }
}
```

#### Update Alert Thresholds
**POST** `/api/admin/notifications`

**Request:**
```json
{
  "action": "updateAlertThresholds",
  "config": {
    "alertThresholds": {
      "certificateExpiryDays": 45,
      "crlUpdateHours": 26,
      "diskUsagePercent": 80,
      "memoryUsagePercent": 85
    }
  }
}
```

#### Update Webhook Settings
**POST** `/api/admin/notifications`

**Request:**
```json
{
  "action": "updateWebhookSettings",
  "config": {
    "webhookSettings": {
      "enabled": true,
      "url": "https://api.example.com/webhooks/ca-events",
      "secret": "your-webhook-secret",
      "events": ["certificate_issued", "certificate_revoked", "crl_updated", "ca_renewed"]
    }
  }
}
```

### Health Monitoring API

#### Get Health Status
**GET** `/api/admin/health`

**Response:**
```json
{
  "status": "healthy",
  "timestamp": "2025-01-15T14:30:00.000Z",
  "checks": {
    "database": {
      "status": "healthy",
      "responseTime": 45,
      "lastChecked": "2025-01-15T14:30:00.000Z"
    },
    "certificateAuthority": {
      "status": "healthy",
      "activeCAs": 2,
      "lastChecked": "2025-01-15T14:30:00.000Z"
    },
    "ocspResponder": {
      "status": "healthy",
      "uptime": "99.9%",
      "lastChecked": "2025-01-15T14:30:00.000Z"
    },
    "systemResources": {
      "status": "healthy",
      "cpuUsage": 45,
      "memoryUsage": 60,
      "diskUsage": 30,
      "lastChecked": "2025-01-15T14:30:00.000Z"
    }
  }
}
```

### Audit & Sessions API

#### Get Audit Logs
**GET** `/api/admin/audit?limit=50&page=1&action=LOGIN&userId=123`

**Response:**
```json
{
  "logs": [
    {
      "id": "audit_123",
      "timestamp": "2025-01-15T14:30:00.000Z",
      "action": "LOGIN",
      "userId": "user_456",
      "username": "admin",
      "ipAddress": "192.168.1.100",
      "userAgent": "Mozilla/5.0...",
      "details": {
        "successful": true,
        "method": "password"
      }
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 50,
    "total": 1250,
    "pages": 25
  }
}
```

#### Get Active Sessions
**GET** `/api/admin/sessions`

**Response:**
```json
{
  "sessions": [
    {
      "id": "session_123",
      "userId": "user_456",
      "username": "admin",
      "ipAddress": "192.168.1.100",
      "userAgent": "Mozilla/5.0...",
      "createdAt": "2025-01-15T10:30:00.000Z",
      "lastActivity": "2025-01-15T14:30:00.000Z",
      "expiresAt": "2025-01-15T16:30:00.000Z"
    }
  ],
  "summary": {
    "totalActive": 5,
    "adminSessions": 2,
    "operatorSessions": 3
  }
}
```

#### Force Session Logout
**POST** `/api/admin/sessions`

**Request:**
```json
{
  "action": "forceLogout",
  "sessionId": "session_123"
}
```

## Users, Profile, Notifications, Audit

The application also exposes endpoints for:
- Users: create, update, delete, reset-password, list
- Profile: read, update, change-password
- Notifications: settings CRUD, test webhooks, history
- Audit: list and export

All these routes accept the same Bearer token in the `Authorization` header.

## Demo CA on Startup

On first start, the app auto-creates a demo, self-signed CA if none exists (can be disabled via `DEMO_CA_AUTO_INIT=false`). You can also create one explicitly via the `/api/ca/self-signed` endpoint.

## Environment Variables (selected)

- `NEXTAUTH_SECRET` or `AUTH_SECRET` (required for secure JWTs)
- `SESSION_MAX_AGE` (token/session lifetime in seconds; default 86400)
- `CRL_DISTRIBUTION_POINT` (default `http://localhost:3000/api/crl/download/latest`)
- `OCSP_URL` (default `http://localhost:3000/api/ocsp`)
- `ALLOW_EXTENDED_CERT_FORMATS` (set `true` to accept DER/PKCS#7 upload inputs)
- `DEMO_CA_AUTO_INIT` (set `false` to disable auto demo CA setup)

## Error Handling

Errors are returned as JSON:
```json
{ "error": "message", "details": "optional details" }
```

## Curl Examples

- Issue token:
```
TOKEN=$(curl -s -X POST http://localhost:3000/api/auth/token \
  -H 'content-type: application/json' \
  -d '{"username":"admin","password":"admin123"}' | jq -r .access_token)
```

- Create self-signed CA:
```
curl -X POST http://localhost:3000/api/ca/self-signed \
  -H "authorization: Bearer $TOKEN" \
  -H 'content-type: application/json' \
  -d '{"subjectDN":"C=US,ST=CA,L=SF,O=Demo,OU=IT,CN=Demo Root CA","keyAlgorithm":"RSA","keySize":2048,"validityDays":3650}'
```

- Issue server certificate:
```
curl -X POST http://localhost:3000/api/certificates/issue \
  -H "authorization: Bearer $TOKEN" \
  -H 'content-type: application/json' \
  -d '{"subjectDN":"CN=test.example.com","certificateType":"SERVER","keyAlgorithm":"RSA","keySize":2048,"validityDays":365,"sans":["test.example.com"]}'
```

- Revoke certificate:
```
curl -X POST http://localhost:3000/api/certificates/revoke \
  -H "authorization: Bearer $TOKEN" \
  -H 'content-type: application/json' \
  -d '{"serialNumber":"<HEX>","reason":"KEY_COMPROMISE"}'
```

- Generate CRL:
```
curl -X POST http://localhost:3000/api/crl/generate \
  -H "authorization: Bearer $TOKEN" \
  -H 'content-type: application/json' \
  -d '{"type":"full"}'
```

---

For questions or issues, please open an issue in this repository.
