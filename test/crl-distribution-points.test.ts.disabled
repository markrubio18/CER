import { describe, it, expect, beforeEach } from '@jest/globals';
import { CAService } from '@/lib/ca';
import { db } from '@/lib/db';
import { X509Utils } from '@/lib/crypto';

// Mock database
jest.mock('@/lib/db', () => ({
  db: {
    cAConfig: {
      findFirst: jest.fn(),
      findUnique: jest.fn(),
    },
    certificate: {
      create: jest.fn(),
    },
    certificateRevocation: {
      findMany: jest.fn(),
    },
  },
}));

// Mock audit service
jest.mock('@/lib/audit', () => ({
  AuditService: {
    log: jest.fn(),
  },
}));

import { Encryption } from '@/lib/crypto';
import forge from 'node-forge';

// Helper to create a valid self-signed CA for mocking
const createMockCa = () => {
  const caKeys = forge.pki.rsa.generateKeyPair(2048);
  const caCert = forge.pki.createCertificate();
  caCert.publicKey = caKeys.publicKey;
  caCert.serialNumber = '01';
  caCert.validity.notBefore = new Date();
  caCert.validity.notAfter = new Date();
  caCert.validity.notAfter.setFullYear(caCert.validity.notBefore.getFullYear() + 1);
  const caAttrs = [{ name: 'commonName', value: 'Test CA' }];
  caCert.setSubject(caAttrs);
  caCert.setIssuer(caAttrs);
  caCert.setExtensions([{ name: 'basicConstraints', cA: true, critical: true }]);
  caCert.sign(caKeys.privateKey, forge.md.sha256.create());

  const encryptedKey = Encryption.encrypt(forge.pki.privateKeyInfoToPem(caKeys.privateKey));

  return {
    id: 'test-ca-id',
    subjectDN: 'CN=Test CA',
    status: 'ACTIVE',
    certificate: forge.pki.certificateToPem(caCert),
    privateKey: JSON.stringify(encryptedKey),
    crlDistributionPoint: 'https://test.example.com/api/crl/download/latest',
    ocspUrl: 'https://test.example.com/api/ocsp',
    crlNumber: 1,
  };
};

describe('CRL Distribution Points in Certificates', () => {
  beforeEach(() => {
    jest.clearAllMocks();
    const mockCaConfig = createMockCa();
    (db.cAConfig.findFirst as jest.Mock).mockResolvedValue(mockCaConfig);
    (db.cAConfig.findUnique as jest.Mock).mockResolvedValue(mockCaConfig);
  });

  describe('Certificate Issuance with CRL Distribution Points', () => {
    it('should include CRL distribution points in issued certificates', async () => {
      // Mock certificate creation
      (db.certificate.create as jest.Mock).mockResolvedValue({
        id: 'test-cert-id',
        serialNumber: '1234567890ABCDEF',
      });

      // Generate a valid CSR for the test
      const clientKeys = forge.pki.rsa.generateKeyPair(2048);
      const csr = forge.pki.createCertificationRequest();
      csr.publicKey = clientKeys.publicKey;
      csr.setSubject([{ name: 'commonName', value: 'test.example.com' }]);
      csr.sign(clientKeys.privateKey, forge.md.sha256.create());
      const csrPem = forge.pki.certificationRequestToPem(csr);

      // Issue certificate
      const result = await CAService.issueCertificate({
        subjectDN: 'CN=test.example.com',
        certificateType: 'SERVER',
        keyAlgorithm: 'RSA',
        validityDays: 365,
        sans: ['test.example.com'],
        csr: csrPem,
      }, 'test-user-id');

      // Verify certificate was created
      expect(db.certificate.create).toHaveBeenCalled();
      
      // Verify the certificate includes CRL distribution points
      const createdCert = (db.certificate.create as jest.Mock).mock.calls[0][0].data;
      expect(createdCert.certificate).toBeDefined();
      
      // Parse certificate and check extensions
      const certText = createdCert.certificate;
      
      // Check for CRL distribution points
      expect(certText).toContain('X509v3 CRL Distribution Points');
      expect(certText).toContain('https://test.example.com/api/crl/download/latest');
      
      // Check for Authority Information Access
      expect(certText).toContain('X509v3 Authority Information Access');
      expect(certText).toContain('https://test.example.com/api/ocsp');
      
      // Check for Certificate Policies
      expect(certText).toContain('X509v3 Certificate Policies');
    });

    it('should include proper revocation reason codes in CRL distribution points', async () => {
      // Mock certificate creation
      (db.certificate.create as jest.Mock).mockResolvedValue({
        id: 'test-cert-id',
        serialNumber: '1234567890ABCDEF',
      });

      // Generate a valid CSR for the test
      const clientKeys = forge.pki.rsa.generateKeyPair(2048);
      const csr = forge.pki.createCertificationRequest();
      csr.publicKey = clientKeys.publicKey;
      csr.setSubject([{ name: 'commonName', value: 'test.example.com' }]);
      csr.sign(clientKeys.privateKey, forge.md.sha256.create());
      const csrPem = forge.pki.certificationRequestToPem(csr);

      // Issue certificate
      const result = await CAService.issueCertificate({
        subjectDN: 'CN=test.example.com',
        certificateType: 'SERVER',
        keyAlgorithm: 'RSA',
        validityDays: 365,
        sans: ['test.example.com'],
        csr: csrPem,
      }, 'test-user-id');

      // Verify certificate was created
      expect(db.certificate.create).toHaveBeenCalled();
      
      const createdCert = (db.certificate.create as jest.Mock).mock.calls[0][0].data;
      const certText = createdCert.certificate;
      
      // Check for revocation reason codes in CRL distribution points
      expect(certText).toContain('reasons:');
      expect(certText).toMatch(/reasons:\s*\[.*1.*2.*3.*4.*5.*6.*8.*9.*10.*\]/);
    });
  });

  describe('CRL Generation with Extensions', () => {
    it('should generate CRL with proper extensions', async () => {
      // Mock revoked certificates
      (db.certificateRevocation.findMany as jest.Mock).mockResolvedValue([
        {
          serialNumber: '1234567890ABCDEF',
          revocationDate: new Date(),
          revocationReason: 'KEY_COMPROMISE',
          certificate: { caId: 'test-ca-id' },
        },
      ]);

      // Mock CRL creation
      const mockCRL = {
        create: jest.fn().mockResolvedValue({ id: 'test-crl-id' }),
      };
      (db as any).cRL = mockCRL;

      // Generate CRL
      const crl = await CAService.generateCRL('test-ca-id');

      // Verify CRL was created
      expect(mockCRL.create).toHaveBeenCalled();
      
      // Verify CRL includes proper extensions
      expect(crl).toContain('-----BEGIN X509 CRL-----');
      expect(crl).toContain('-----END X509 CRL-----');
      
      // Check for CRL extensions
      expect(crl).toContain('X509v3 CRL Number');
      expect(crl).toContain('X509v3 Authority Key Identifier');
      expect(crl).toContain('X509v3 Issuing Distribution Point');
    });
  });

  describe('Environment Configuration', () => {
    it('should use environment variables for CRL and OCSP URLs', () => {
      // Set environment variables
      process.env.CRL_DISTRIBUTION_POINT = 'https://prod.example.com/crl';
      process.env.OCSP_URL = 'https://prod.example.com/ocsp';

      // Verify environment variables are used
      expect(process.env.CRL_DISTRIBUTION_POINT).toBe('https://prod.example.com/crl');
      expect(process.env.OCSP_URL).toBe('https://prod.example.com/ocsp');
    });
  });
});