# API Reference

This document describes how to use the application entirely over HTTP APIs. All features available in the Web UI are also exposed via the API.

## Base URL

- Local development: `http://localhost:3000`

## Authentication

Protected endpoints accept either:
- NextAuth session cookies (from the web UI), or
- Bearer tokens (recommended for programmatic API use)

### Obtain a token

POST `/api/auth/token`

Request body:
```json
{ "username": "admin", "password": "admin123" }
```

Response:
```json
{
  "access_token": "<JWT>",
  "token_type": "Bearer",
  "expires_in": 86400
}
```

Use the token in subsequent calls:
```
Authorization: Bearer <JWT>
```

Environment notes:
- Set a strong `NEXTAUTH_SECRET` (or `AUTH_SECRET`).
- `SESSION_MAX_AGE` controls token lifetime (seconds).

## Certificate Authority (CA)

### Get CA status list
GET `/api/ca/status`

```
curl -H "authorization: Bearer $TOKEN" \
  http://localhost:3000/api/ca/status
```

### Get CA details
GET `/api/ca/{id}`

```
curl -H "authorization: Bearer $TOKEN" \
  http://localhost:3000/api/ca/<CA_ID>
```

### Delete a CA (and all its artifacts)
DELETE `/api/ca/{id}`

```
curl -X DELETE -H "authorization: Bearer $TOKEN" \
  http://localhost:3000/api/ca/<CA_ID>
```

### Initialize CA (CSR-based)
POST `/api/ca/initialize`

Request body (example):
```json
{
  "name": "Org CA",
  "subjectDN": "C=US,ST=CA,L=SF,O=MyOrg,OU=IT,CN=Root CA",
  "keyAlgorithm": "RSA",
  "keySize": 4096
}
```
Response contains `{ caId, csr, privateKey }`.

### Upload signed CA certificate
POST `/api/ca/upload-certificate`

Request body:
```json
{
  "caId": "<CA_ID>",
  "certificate": "-----BEGIN CERTIFICATE-----...",
  "certificateChain": "-----BEGIN CERTIFICATE-----..."
}
```

Extended formats (opt-in via `ALLOW_EXTENDED_CERT_FORMATS=true`):
- `certificateBinary` (base64) with `certificateBinaryFormat`: `der` or `p7b`
- Optional `chainBinary` + `chainBinaryFormat`

### Create a self-signed CA (one-step)
POST `/api/ca/self-signed`

Request body (example):
```json
{
  "name": "Demo CA",
  "subjectDN": "C=US,ST=CA,L=SF,O=Demo,OU=IT,CN=Demo Root CA",
  "keyAlgorithm": "RSA",
  "keySize": 2048,
  "validityDays": 3650,
  "force": false
}
```

Response contains `{ id, certificate }` and activates the CA immediately.

## Certificates

### Issue a certificate
POST `/api/certificates/issue`

Request (key pair generated by CA):
```json
{
  "subjectDN": "CN=test.example.com",
  "certificateType": "SERVER",
  "keyAlgorithm": "RSA",
  "keySize": 2048,
  "validityDays": 365,
  "sans": ["test.example.com", "www.test.example.com"]
}
```

Request (external CSR):
```json
{
  "subjectDN": "CN=test.example.com",
  "certificateType": "SERVER",
  "keyAlgorithm": "RSA",
  "validityDays": 365,
  "csr": "-----BEGIN CERTIFICATE REQUEST-----..."
}
```

Response contains `{ certificate, privateKey?, serialNumber, fingerprint }`.

Notes:
- `certificateType`: `SERVER` | `CLIENT` | `CA`
- For `SERVER`, at least one SAN is required; max validity 398 days.
- `keyAlgorithm`: `RSA` or `ECDSA` (Ed25519 not supported for signing).

### List certificates
GET `/api/certificates?limit=20&page=1&type=SERVER&status=ACTIVE&subjectDN=example.com`

### Revoke a certificate
POST `/api/certificates/revoke`

```json
{ "serialNumber": "<HEX>", "reason": "KEY_COMPROMISE" }
```

Allowed reasons:
`UNSPECIFIED, KEY_COMPROMISE, CA_COMPROMISE, AFFILIATION_CHANGED, SUPERSEDED, CESSATION_OF_OPERATION, CERTIFICATE_HOLD, REMOVE_FROM_CRL, PRIVILEGE_WITHDRAWN, AA_COMPROMISE`

### Renew a certificate
POST `/api/certificates/{serialNumber}/renew`

## CRL (Certificate Revocation List)

### Generate CRL
POST `/api/crl/generate`

```json
{ "type": "full", "caId": "<optional>" }
```

For delta CRL:
```json
{ "type": "delta", "caId": "<optional>" }
```

Response includes the PEM CRL.

### Download latest CRL
GET `/api/crl/download/latest`

### Download CRL by number
GET `/api/crl/download/{crlNumber}`

### CRL status and export
- GET `/api/crl/status`
- GET `/api/crl/export`

### Validate a CRL (structure/compliance)
POST `/api/crl/validate`

```json
{ "crlPem": "-----BEGIN X509 CRL-----..." }
```

## OCSP

### JSON OCSP
POST `/api/ocsp`

Body: implementation-specific certificate status query.

### Binary OCSP (RFC 6960)
POST `/api/ocsp/binary`

Headers:
```
content-type: application/ocsp-request
accept: application/ocsp-response
```

Body: DER-encoded OCSP request bytes.

## Users, Profile, Notifications, Audit

The application also exposes endpoints for:
- Users: create, update, delete, reset-password, list
- Profile: read, update, change-password
- Notifications: settings CRUD, test webhooks, history
- Audit: list and export

All these routes accept the same Bearer token in the `Authorization` header.

## Demo CA on Startup

On first start, the app auto-creates a demo, self-signed CA if none exists (can be disabled via `DEMO_CA_AUTO_INIT=false`). You can also create one explicitly via the `/api/ca/self-signed` endpoint.

## Environment Variables (selected)

- `NEXTAUTH_SECRET` or `AUTH_SECRET` (required for secure JWTs)
- `SESSION_MAX_AGE` (token/session lifetime in seconds; default 86400)
- `CRL_DISTRIBUTION_POINT` (default `http://localhost:3000/api/crl/download/latest`)
- `OCSP_URL` (default `http://localhost:3000/api/ocsp`)
- `ALLOW_EXTENDED_CERT_FORMATS` (set `true` to accept DER/PKCS#7 upload inputs)
- `DEMO_CA_AUTO_INIT` (set `false` to disable auto demo CA setup)

## Error Handling

Errors are returned as JSON:
```json
{ "error": "message", "details": "optional details" }
```

## Curl Examples

- Issue token:
```
TOKEN=$(curl -s -X POST http://localhost:3000/api/auth/token \
  -H 'content-type: application/json' \
  -d '{"username":"admin","password":"admin123"}' | jq -r .access_token)
```

- Create self-signed CA:
```
curl -X POST http://localhost:3000/api/ca/self-signed \
  -H "authorization: Bearer $TOKEN" \
  -H 'content-type: application/json' \
  -d '{"subjectDN":"C=US,ST=CA,L=SF,O=Demo,OU=IT,CN=Demo Root CA","keyAlgorithm":"RSA","keySize":2048,"validityDays":3650}'
```

- Issue server certificate:
```
curl -X POST http://localhost:3000/api/certificates/issue \
  -H "authorization: Bearer $TOKEN" \
  -H 'content-type: application/json' \
  -d '{"subjectDN":"CN=test.example.com","certificateType":"SERVER","keyAlgorithm":"RSA","keySize":2048,"validityDays":365,"sans":["test.example.com"]}'
```

- Revoke certificate:
```
curl -X POST http://localhost:3000/api/certificates/revoke \
  -H "authorization: Bearer $TOKEN" \
  -H 'content-type: application/json' \
  -d '{"serialNumber":"<HEX>","reason":"KEY_COMPROMISE"}'
```

- Generate CRL:
```
curl -X POST http://localhost:3000/api/crl/generate \
  -H "authorization: Bearer $TOKEN" \
  -H 'content-type: application/json' \
  -d '{"type":"full"}'
```

---

For questions or issues, please open an issue in this repository.